services:
  arcturus:
    build:
      context: arcturus
    env_file:
      - .env
    volumes:
      - ./assets/:/app/assets/
    ports:
      #- 3000:3000 # gameport
      #- 3001:3001 # rcon
      - 2096:2096 # websocket port
    depends_on:
      - db
    restart: unless-stopped
    networks: [nitro]

  nitro:
    build:
      context: nitro
    env_file:
      - .env
    volumes:
      - ./nitro/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./nitro/renderer-config.json:/usr/share/nginx/html/renderer-config.json
      - ./nitro/ui-config.json:/usr/share/nginx/html/ui-config.json
    ports:
      - 3000:80
    restart: unless-stopped
    networks: [nitro]

  db:
    image: mysql:8
    depends_on:
      - backup
    env_file:
      - .env
    ports:
      - 3310:3306
    volumes:
      - ./db/data:/var/lib/mysql
      - ./db/conf.d:/etc/mysql/conf.d
      - ./db/dumps:/docker-entrypoint-initdb.d
    restart: unless-stopped
    networks: [nitro]

  backup:
    image: tiredofit/db-backup:4.0.19
    volumes:
      - ./db/backup:/backup
    environment:
      - TIMEZONE=UTC
      - CONTAINER_ENABLE_MONITORING=FALSE
      - DEFAULT_LOG_LEVEL=WARN

      - DEFAULT_CREATE_LATEST_SYMLINK=FALSE
      - BACKUP_JOB_CONCURRENCY=1
      - DEFAULT_CHECKSUM=SHA1
      - DEFAULT_COMPRESSION=GZ
      - DEFAULT_BACKUP_INTERVAL=1440
      - DEFAULT_BACKUP_BEGIN=0315
      - DEFAULT_CLEANUP_TIME=10080

      - DB01_TYPE=mysql
      - DB01_HOST=db
      - DB01_NAME=$MYSQL_USER
      - DB01_USER=$MYSQL_USER
      - DB01_PASS=$MYSQL_PASSWORD
      - DB01_NAME=$MYSQL_DATABASE
    restart: unless-stopped
    networks: [nitro]

  assets:
    image: nginx:alpine
    restart: unless-stopped
    depends_on:
      - imager
      - imgproxy
    env_file:
      - .env
    ports:
      - 8080:80
    volumes:
      - ./assets/nginx:/etc/nginx/conf.d/
      - ./assets/:/usr/share/nginx/html
    networks: [nitro]

  imager:
    build:
      context: imager
    env_file:
      - .env
    volumes:
      - ./assets/:/app/assets/
    restart: unless-stopped
    networks: [nitro]

  imgproxy:
    image: ghcr.io/willnorris/imageproxy
    volumes:
      - "./assets/usercontent/imageproxy/cache:/tmp/imageproxy"
    env_file:
      - .env
    restart: unless-stopped
    networks: [nitro]

  cms:
    build:
      context: atomcms
    depends_on:
      - assets
      - arcturus
    ports:
      - "8081:8080"
    volumes:
      - "./.cms.env:/var/www/html/.env"
      - "./atomcms/storage:/var/www/html/storage/app/public"
      - "./atomcms/logs:/var/www/html/storage/logs"
      - "./atomcms/gamedata:/var/www/html/public/gamedata"
    restart: unless-stopped
    networks: [nitro]

networks:
  nitro:
